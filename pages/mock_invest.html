<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JamMoney - 모의 투자</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/mock_invest.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <div class="main-content">
      <header>
        <button class="back-button" onclick="history.back();">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M15 19L8 12L15 5"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
        모의투자
      </header>

      <div class="content">
        <div class="stock-header">
          <h2 class="title">
            동양철관 <img src="../assets/icon/search.svg" alt="" />
          </h2>
          <div class="current-price">1,397원</div>
          <div class="price-change">어제보다 0 (0%)</div>
        </div>

        <div class="tab-menu">
          <button data-tab="chart" class="active">차트</button>
          <button data-tab="time">시간</button>
          <button data-tab="date">일자</button>
          <button data-tab="company">기업정보</button>
        </div>

        <div id="tab-content">
          <div id="chart" class="tab-pane active" style="position: relative">
            <div class="chart-wrapper">
              <svg id="candleChart"></svg>
              <div class="tooltip-box" id="tooltip" style="display: none"></div>
            </div>

            <div class="period-tabs">
              <button data-range="1d" class="active">1일</button>
              <button data-range="3m">3달</button>
              <button data-range="1y">1년</button>
            </div>
          </div>
          <div id="time" class="tab-pane">
            <table>
              <thead>
                <tr>
                  <td>시간</td>
                  <td>현재가</td>
                  <td>대비</td>
                  <td>누적체결수량</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>15:30:57</td>
                  <td>1,397</td>
                  <td class="change">
                    <span class="arrow">-</span> <span class="value">0</span>
                  </td>
                  <td>9,856,382</td>
                </tr>
                <tr>
                  <td>15:30:55</td>
                  <td>1,397</td>
                  <td class="change">
                    <span class="arrow">-</span> <span class="value">0</span>
                  </td>
                  <td>9,856,382</td>
                </tr>
                <tr>
                  <td>15:30:53</td>
                  <td>1,397</td>
                  <td class="change">
                    <span class="arrow">-</span> <span class="value">0</span>
                  </td>
                  <td>9,856,382</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="date" class="tab-pane">
            <table>
              <thead>
                <tr>
                  <td>일자</td>
                  <td>종가</td>
                  <td>대비</td>
                  <td>누적거래량</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2025.05.02</td>
                  <td>1,397</td>
                  <td class="change up">
                    <span class="arrow">▲</span> <span class="value">83</span>
                  </td>
                  <td>9,856,382</td>
                </tr>
                <tr>
                  <td>2025.04.30</td>
                  <td>1,393</td>
                  <td class="change down">
                    <span class="arrow">▼</span> <span class="value">79</span>
                  </td>
                  <td>11,477,186</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="company" class="tab-pane">
            <table class="company-info-table">
              <tbody>
                <tr>
                  <td class="label">기준가</td>
                  <td class="value" data-label="기준가"></td>
                  <td class="label">전일종가</td>
                  <td class="value" data-label="전일종가"></td>
                </tr>
                <tr>
                  <td class="label">시작가</td>
                  <td class="value" data-label="시작가"></td>
                  <td class="label">종가</td>
                  <td class="value" data-label="종가"></td>
                </tr>
                <tr>
                  <td class="label">고가</td>
                  <td class="value" data-label="고가"></td>
                  <td class="label">저가</td>
                  <td class="value" data-label="저가"></td>
                </tr>
                <tr>
                  <td class="label">상한가</td>
                  <td class="value" data-label="상한가"></td>
                  <td class="label">하한가</td>
                  <td class="value" data-label="하한가"></td>
                </tr>
                <tr>
                  <td class="label">누적거래량</td>
                  <td class="value" data-label="누적거래량"></td>
                  <td class="label">거래대금</td>
                  <td class="value" data-label="거래대금"></td>
                </tr>
                <tr>
                  <td class="label">시가총액</td>
                  <td class="value" data-label="시가총액"></td>
                  <td class="label">액면가</td>
                  <td class="value" data-label="액면가"></td>
                </tr>
                <tr>
                  <td class="label">상장일자</td>
                  <td class="value" data-label="상장일자"></td>
                  <td class="label">상장수량</td>
                  <td class="value" data-label="상장수량"></td>
                </tr>
                <tr>
                  <td class="label" colspan="2">시장정보구분(투자주의)</td>
                  <td
                    class="value"
                    colspan="2"
                    data-label="시장정보구분(투자주의)"
                  ></td>
                </tr>
                <tr>
                  <td class="label" colspan="2">업종분류</td>
                  <td class="value" colspan="2" data-label="업종분류"></td>
                </tr>
                <tr>
                  <td class="label">관리종목</td>
                  <td class="value" data-label="관리종목"></td>
                  <td class="label">거래정지</td>
                  <td class="value" data-label="거래정지"></td>
                </tr>
                <tr>
                  <td class="label">배당수익률</td>
                  <td class="value" data-label="배당수익률">%</td>
                  <td class="label">주당배당금</td>
                  <td class="value" data-label="주당배당금"></td>
                </tr>
                <tr>
                  <td class="label">EPS</td>
                  <td class="value" data-label="EPS"></td>
                  <td class="label">PER</td>
                  <td class="value" data-label="PER">배</td>
                </tr>
                <tr>
                  <td class="label">BPS</td>
                  <td class="value" data-label="BPS"></td>
                  <td class="label">PBR</td>
                  <td class="value" data-label="PBR">배</td>
                </tr>
                <tr>
                  <td class="label">결산월</td>
                  <td class="value" colspan="3" data-label="결산월">월</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <button class="trade-btn">거래하기</button>
      </div>
    </div>
    <div id="navbar"></div>
    <script src="../js/script.js"></script>
    <script
      type="module"
      src="../js/features/mock_invest/mock-info.js"
    ></script>
    <script>
      const buttons = document.querySelectorAll('.tab-menu button');
      const panes = document.querySelectorAll('.tab-pane');

      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const target = button.dataset.tab;

          buttons.forEach((btn) => btn.classList.remove('active'));
          panes.forEach((pane) => pane.classList.remove('active'));

          button.classList.add('active');
          document.getElementById(target).classList.add('active');
        });
      });
      const data = [
        {
          date: new Date('2025-05-07T10:00:00'),
          open: 1366,
          high: 1370,
          low: 1361,
          close: 1364,
        },
        {
          date: new Date('2025-05-07T10:10:00'),
          open: 1364,
          high: 1374,
          low: 1358,
          close: 1370,
        },
        {
          date: new Date('2025-05-07T10:20:00'),
          open: 1370,
          high: 1378,
          low: 1366,
          close: 1361,
        },
        {
          date: new Date('2025-05-07T10:30:00'),
          open: 1361,
          high: 1367,
          low: 1355,
          close: 1359,
        },
      ];

      const svg = d3.select('#candleChart');
      const tooltip = d3.select('#tooltip');
      const svgNode = document.getElementById('candleChart');
      const rect = svgNode.getBoundingClientRect();
      const svgWidth = rect.width;
      const svgHeight = rect.height;

      const margin = { top: 20, right: 60, bottom: 30, left: 60 };
      const width = svgWidth - margin.left - margin.right;
      const height = svgHeight - margin.top - margin.bottom;

      const chartGroup = svg
        .attr('viewBox', `0 0 ${svgWidth} ${svgHeight}`)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3
        .scaleTime()
        .domain([
          d3.min(data, (d) => d.date),
          d3.timeMinute.offset(
            d3.max(data, (d) => d.date),
            10
          ), // 오른쪽으로 10분 추가
        ])
        .range([0, width]);
      const y = d3.scaleLinear().domain([1350, 1380]).range([height, 0]);

      chartGroup
        .append('g')
        .attr('transform', `translate(${width},0)`)
        .call(d3.axisRight(y));
      chartGroup
        .append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(4).tickFormat(d3.timeFormat('%H:%M')));

      chartGroup
        .selectAll('.candle')
        .data(data)
        .enter()
        .append('rect')
        .attr('x', (d) => x(d.date) - 5)
        .attr('y', (d) => y(Math.max(d.open, d.close)))
        .attr('width', 10)
        .attr('height', (d) => Math.abs(y(d.open) - y(d.close)))
        .attr('fill', (d) => (d.close > d.open ? '#d32f2f' : '#1976d2'));

      chartGroup
        .selectAll('.wick')
        .data(data)
        .enter()
        .append('line')
        .attr('x1', (d) => x(d.date))
        .attr('x2', (d) => x(d.date))
        .attr('y1', (d) => y(d.high))
        .attr('y2', (d) => y(d.low))
        .attr('stroke', (d) => (d.close > d.open ? '#d32f2f' : '#1976d2'));

      const guidelineV = chartGroup
        .append('line')
        .attr('stroke', '#ccc')
        .attr('stroke-dasharray', '4')
        .attr('y1', 0)
        .attr('y2', height)
        .style('display', 'none');
      const guidelineH = chartGroup
        .append('line')
        .attr('stroke', '#ccc')
        .attr('stroke-dasharray', '4')
        .attr('x1', 0)
        .attr('x2', width)
        .style('display', 'none');

      svg.on('mousemove', function (event) {
        const [mouseX, mouseY] = d3.pointer(event);
        const x0 = x.invert(mouseX - margin.left);
        const bisect = d3.bisector((d) => d.date).center;
        const index = bisect(data, x0);
        const d = data[index];
        if (!d) return;

        guidelineV
          .attr('x1', x(d.date))
          .attr('x2', x(d.date))
          .style('display', 'block');
        guidelineH
          .attr('y1', y(d.close))
          .attr('y2', y(d.close))
          .style('display', 'block');

        tooltip
          .style('display', 'block')
          .style('left', `${x(d.date) + margin.left + 10}px`)
          .style('top', `${y(d.high)}px`).html(`
            <strong>${d3.timeFormat('%Y-%m-%d %H:%M')(d.date)}</strong><br/>
            종가: ${
              d.close
            } <span class="${d.close > d.open ? 'up' : 'down'}">(${(((d.close - d.open) / d.open) * 100).toFixed(2)}%)</span><br/>
            시가: ${
              d.open
            } <span class="${d.open > d.close ? 'down' : 'up'}">(${(((d.open - d.close) / d.close) * 100).toFixed(2)}%)</span><br/>
            고가: ${d.high}<br/>
            저가: ${d.low}
          `);
      });

      svg.on('mouseleave', function () {
        tooltip.style('display', 'none');
        guidelineV.style('display', 'none');
        guidelineH.style('display', 'none');
      });
    </script>
  </body>
</html>
